# Контекст и описание проблемы

## Проблемы взаимодействия с ins-product-aggregator

В текущей архитектуре `core-app` сильно зависит от доступности внешних сервисов при загрузке продуктов и тарифов. Зависимость возникает из-за синхронного характера взаимодействия и внутренней реализации `ins-product-aggregator` сервиса. `ins-product-aggregator` сам никак не хранит данные получаемые из систем страховых компаний, и поэтому вынужден каждый раз запрашивать и сразу отдавать их потребителям (`core-app`, `ins-comp-settlement`). Синхронное взаимодействие реализовано на `REST`, из-за чего любая ошибка в получении данных из страховых компаний может привести к падению всего запроса. А если внешние сервисы долго отвечают, то есть риски таймаута вызова. Вызов приходится повторять снова и снова что может приводить даже к так называемому "шторму повторных попыток" (`retry storm`). Учитывая, что в планах интегрироваться с ещё пятью страховыми компаниями, текущая архитектура будет работать очень нестабильно.

Проблемой также является вероятная несогласованность данных из-за репликаций данных с разной периодичностью в `core-app` и `ins-comp-settlement` - раз в 15 минут и раз в сутки соответственно. Локальные реплики могут содержать разные наборы данных и принимать несогласованные решения.

Своего рода проблемой можно также считать жёсткую связь по расписанию - ведь периодичность обновления локальных реплик зашита в логику сервисов. При необходимости изменить частоту обновлений требуется измеение двух сервисов.

## Проблемы взаимодействия ins-comp-settlement с core-app

Синхронная выгрузка больших объёмов данных из core-app может создавать серьёзную нагрузку на этот сервис. Особенно в будущем, когда ожидается увеличение количества проводимых сделок.

Использование одноразового `REST`-вызова понижает гарантии успешной обработки данных на стороне `ins-comp-settlement`. Ведь если процесс в `ins-comp-settlement` упадёт после получения данных но до их обработки, то данные могут быть утеряены. Или придётся повторять запрос.

`ins-comp-settlement` зависит от доступности `core-app` в строго определённый момент времени.

И вдобавок в `core-app` могут меняться данные по страховкам уже после выгрузки в `ins-comp-settlement` -  а значит последний будет работать с неактуальной информацией.

# Риски

В первую очередь посмотрим на риски с точки зрения бизнеса:

* **Потеря клиентов** - из-за задержек загрузки продуктов и тарифов может тормозиться оформление страховок
* **Репутационные риски** - клиенты могут получать неактуальные данные о тарифах
* **Финансовые потери** - расхождения в данных могут привести к ошибкам во внешних отчётах и, как следствие, к убыткам или конфликтам с партнёрами.

Также можно отметить технические риски:

* **сбои и замеделения** в `ins-product-aggregator` могут привести к каскадным отказам в других сервисах
* при масштабировании бизнеса **производительность** `ins-product-aggregator` станет критичным узлом
* из-за наличия множества копий данных, которые могут быть в рассинхроне, **усложняются поддержка и отладка**
* текущая схема взаимодействия `core-app` и `ins-comp-settlement` **не является отказоустойчивой**. При сбое в момент передаи данных - их часть или все данные могут быть утеряны.

# Решение

См. диаграмму - `InsureTech_C4_сontainer-diagram.drawio`

Необходимо повысить отказоучтойивость и производительность системы за счёт внедрения Event Driven подходов. А именно:

* Управление периодичностью вызовов к внешним сервисам полностью возоложить на `ins-product-aggregator`. Каждый внешний сервис "дёргать" по своему расписанию, которое можно конфигурировать.
* Добавить брокер сообщений для публикации событий о продуктах и тарифах из `ins-product-aggregator`
* Отказаться от агрегации данных из разных сервисов `ins-product-aggregator` - в пользу отправки событий по мере получения информации из внешних систем. Получили информацию по продукту - опубликовали в брокер. Агрегация имела смысл при синхронном взаимодействии дабы сократить количество вызовов, поместив в каждый ответ как можно больше информации
* Добавить в `core-app` и `ins-comp-settlement` консьюмеры сообщений с продуктами и тарифами
* Добавить брокер сообщения для публикации событий из `core-app` о страховых сделках (создание, обновление, отмена)
* Добавить в `ins-comp-settlement` консьюмер для получения событий о страховых сделках
* Добавить реализацию `Transactional Outbox` в `core-app` для поддержания консистентности данных, сохраняемых по сделкам в бизнес таблицах `core-app` и публикуемых в брокер для `ins-comp-settlement`

**(!)** Отдельно про `Transactional Outbox` в `ins-product-aggregator` - пока видится избыточным применение данного паттерна в `ins-product-aggregator`. `ins-product-aggregator` является сугубо интеграционным, а не бизнесовым, сервисом. Из-за этого у него даже пока нет своей БД для хранения бизнесовых сущностей. Чтобы такая БД появилась, должно быть какое-то обоснование. Даже если встанет вопрос кэширования данных внутри `ins-product-aggregator`, то далеко не факт, что это лучше делать в БД. Тут скорее напрашивается быстрый in-memory кэш с инвалидацией по времени (например, 15 минут - ведь именно таким сейчас является интервал запросов из `core-app` в `ins-product-aggregator`).
